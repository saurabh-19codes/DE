

it('calls goToUserStoryDrillDown with correct params when drilldown icon is clicked', async () => {
  // Arrange: render the component with the right product and props
  render(
    <Provider store={mockStore}>
      <DeliveryEfficiencyFeatures
        params={{ metric: 'SayDoChurn', org: 'GMST', product: mockProduct }}
        router={{ push: mockRouterPush, goBack: jest.fn() }}
      />
    </Provider>
  );

  // Find the product row to drilldown on
  const productRow = screen.getByText(mockProduct).closest('tr');
  expect(productRow).toBeInTheDocument();

  // Find the drilldown icon/button inside the row
  const drilldownBtn = within(productRow).getByTestId('goToUserStoryDrillDown-btn').querySelector('svg');
  expect(drilldownBtn).toBeInTheDocument();

  // Act: simulate the click (the interaction that triggers goToUserStoryDrillDown)
  fireEvent.click(drilldownBtn);

  // Assert: the router push handler is called with the expected URL
  const encodedProduct = encodeURIComponent(mockProduct);
  const expectedUrl = `/organization/GMST/saydochurn/${encodedProduct}`;
  expect(mockRouterPush).toHaveBeenCalledWith(expect.stringContaining(expectedUrl));
});


it('shows loading spinner when ratiodChurnData is loading', () => {
  useFetchy.mockReturnValue({ isLoading: true, data: null });
  render(
    <Provider store={mockStore}>
      <DeliveryEfficiencyFeatures params={{ metric: 'SayDoChurn', org: 'GMST'}} router={{ push: jest.fn(), goBack: jest.fn() }} />
    </Provider>
  );
  expect(screen.getByTestId('spinner')).toBeInTheDocument();
}); 
it('shows error message when API fails', () => {
  useFetchy.mockReturnValue({ isLoading: false, error: true, data: null });
  render(
    <Provider store={mockStore}>
      <DeliveryEfficiencyFeatures params={{ metric: 'SayDoChurn', org: 'GMST'}} router={{ push: jest.fn(), goBack: jest.fn() }} />
    </Provider>
  );
  expect(screen.getByText(/error/i)).toBeInTheDocument();
});it('opens modal with correct information on feedback button click', () => {
  render(
    <Provider store={mockStore}>
      <DeliveryEfficiencyFeatures params={{ metric: 'SayDoChurn', org: 'GMST'}} router={{ push: jest.fn(), goBack: jest.fn() }} />
    </Provider>
  );
  fireEvent.click(screen.getByTestId('icon-feedback-button'));
  expect(useCommentWidget().open).toHaveBeenCalled();
});
it('hides removed features when toggle is off', () => {
  render(
    <Provider store={mockStore}>
      <DeliveryEfficiencyFeatures params={{ metric: 'SayDoChurn', org: 'GMST'}} router={{ push: jest.fn(), goBack: jest.fn() }} />
    </Provider>
  );
  fireEvent.click(screen.getByRole('switch'));
  expect(screen.queryByText('Removed Feature')).not.toBeInTheDocument();
});

it('shows "No Data" when APIs return empty body', () => {
  useFetchy.mockReturnValue({ isLoading: false, data: { body: {} } });
  render(
    <Provider store={mockStore}>
      <DeliveryEfficiencyFeatures params={{ metric: 'SayDoChurn', org: 'GMST'}} router={{ push: jest.fn(), goBack: jest.fn() }} />
    </Provider>
  );
  expect(screen.getByText(/No Data/i)).toBeInTheDocument();
});
it('updates data when a different PI is selected from dropdown', () => {
  render(
    <Provider store={mockStore}>
      <DeliveryEfficiencyFeatures params={{ metric: 'SayDoChurn', org: 'GMST'}} router={{ push: jest.fn(), goBack: jest.fn() }} />
    </Provider>
  );
  fireEvent.change(screen.getByTestId('pi-dropdown'), { target: { value: 'New PI' }});
  expect(useFetchy).toHaveBeenCalledWith(expect.objectContaining({ piNames: ['New PI'] }));
});
